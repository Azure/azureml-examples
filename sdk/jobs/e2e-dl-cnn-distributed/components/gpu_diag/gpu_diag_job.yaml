# This runs NCCL test "all_reduce_perf" on a gpu node.
# It helps diagnosis of health of perf issues.
#
# To run, first create the environment (once):
# az ml environment create --file ./nccl_test_env.yml
#
# then:
# az ml job create -f ./gpu_diag_job.yaml --web --resource-group RG --workspace-name WS
#
# NOTES:
# - set process_count_per_instance to the number of gpu on the node
# - set the name of the compute

type: command
description: Runs NCCL-tests on gpu node

name: gpu_diag_nccl_allreduceperf_v1_3
display_name: Gpu Diag (NCCL tests)

#####################
### CUSTOM VALUES ###
#####################
# feel free to change these parameters

inputs:
  # arguments for nccl_test
  ngpus: 1 # leave at 1
  maxbytes: "8G"
  stepfactor: 2

  # env vars for nccl_test
  topology_file: "/opt/microsoft/ndv4-topo.xml"
  nccl_debug: "INFO"
  nccl_ib_pci_relaxed_ordering: 1
  ucx_tls: "tcp"
  ucx_net_devices: "eth0"
  cuda_device_order: "PCI_BUS_ID"
  nccl_socket_ifname: "eth0"

# name of the compute cluster
compute: azureml:nv24-m60

distribution:
  type: mpi
  # IMPORTANT: set equal to number of gpus
  process_count_per_instance: 4

resources:
  instance_count: 1 # to use multiple nodes

####################
### JOB CONTRACT ###
####################
# NOTE: if you modify any of the following
# you'll need to modify the job name above

command: |
  nvcc --version &&
  nvidia-smi &&
  NCCL_TOPO_FILE=${{inputs.topology_file}} &&
  NCCL_DEBUG=${{inputs.nccl_debug}} &&
  NCCL_IB_PCI_RELAXED_ORDERING=${{inputs.nccl_ib_pci_relaxed_ordering}} &&
  UCX_TLS=${{inputs.ucx_tls}} &&
  UCX_NET_DEVICES=${{inputs.ucx_net_devices}} &&
  CUDA_DEVICE_ORDER=${{inputs.cuda_device_order}} &&
  NCCL_SOCKET_IFNAME=${{inputs.nccl_socket_ifname}} &&
  /nccl-tests/build/all_reduce_perf -e ${{inputs.maxbytes}} -f ${{inputs.stepfactor}} -g ${{inputs.ngpus}}

# NOTE: if you modify the command, you'll need to modify the job name above
environment: azureml:nccl_test_openmpi4-1-0-cuda11-1-cudnn8-ubuntu18-04:3

# NOTE: if you modify those, you'll have to modify name
environment_variables:
  AZUREML_COMPUTE_USE_COMMON_RUNTIME: "true"
