# This runs NCCL test "all_reduce_perf" on a gpu node.
# It helps diagnosis of health of perf issues.
#
# To run, first create the environment (once):
# az ml environment create --file ./nccl_test_env.yml
#
# then:
# az ml job create -f ./gpu_diag_job.yaml --web --resource-group RG --workspace-name WS
#
# NOTES:
# - set process_count_per_instance to the number of gpu on the node
# - set the name of the compute

type: command
description: Runs NCCL-tests on gpu node

display_name: Gpu Diag (NCCL tests)

inputs:
  # arguments for nccl_test
  ngpus: 1 # leave at 1
  maxbytes: "8G"
  stepfactor: 2

# name of the compute cluster
compute: azureml:nc24-k80

distribution:
  type: mpi
  # IMPORTANT: set equal to number of gpus
  process_count_per_instance: 4

resources:
  instance_count: 1 # to use multiple nodes

command: |
  nvcc --version &&
  nvidia-smi &&
  /nccl-tests/build/all_reduce_perf -e ${{inputs.maxbytes}} -f ${{inputs.stepfactor}} -g ${{inputs.ngpus}}

environment: azureml:nccl_test_openmpi4-1-0-cuda11-1-cudnn8-ubuntu18-04:3

environment_variables:
  AZUREML_COMPUTE_USE_COMMON_RUNTIME: "true"
  NCCL_DEBUG: "INFO"
  NCCL_IB_PCI_RELAXED_ORDERING: "1"
  UCX_TLS: "tcp"
  UCX_NET_DEVICES: "eth0"
  CUDA_DEVICE_ORDER: "PCI_BUS_ID"
  NCCL_SOCKET_IFNAME: "eth0"
  NCCL_TOPO_FILE: "/opt/microsoft/ndv4-topo.xml"
