name: amlacr-cli-jobs-pipelines-with-components-basics-1b_e2e_registered_components-pipeline
on:
  workflow_dispatch:
    inputs:
      SUBSCRIPTION:
        description: 'Subscription ID'
        required: false
        default: '6560575d-fa06-4e7d-95fb-f962e74efd7a'
      RESOURCE_GROUP:
        description: 'Resource Group'
        required: false
        default: 'azureml-examples-rg'
      WORKSPACE:
        description: 'Workspace Name'
        required: false
        default: 'amlarc-githubtest-ws'
  schedule:
    - cron: "0 0/4 * * *"
  pull_request:
    branches:
      - main
    paths:
      - cli/jobs/pipelines-with-components/basics/1b_e2e_registered_components/**
      - .github/workflows/cli-jobs-pipelines-with-components-basics-1b_e2e_registered_components-pipeline.yml
      - cli/run-pipeline-jobs.sh
      - cli/setup.sh
jobs:
  build:
    env:
      SUBSCRIPTION: ${{ github.event.inputs.SUBSCRIPTION }}
      RESOURCE_GROUP: ${{ github.event.inputs.RESOURCE_GROUP }}
      WORKSPACE: ${{ github.event.inputs.WORKSPACE }}
    runs-on: ubuntu-latest
    steps:
      - name: check out repo
        uses: actions/checkout@v2
      - name: setup python
        uses: actions/setup-python@v2
        with:
          python-version: "3.8"
      - name: install az cli
        shell: bash
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | bash
      - name: install tools
        run: bash .github/amlarc-tool.sh install_tools
        timeout-minutes: 30
      - name: azure login
        uses: azure/login@v1
        with:
          creds: ${{secrets.AZ_AE_CREDS}}
        timeout-minutes: 30

      - name: configure defaults
        run: az configure --defaults group=$RESOURCE_GROUP workspace=$WORKSPACE

      - name: prepare-components
        run: |
          set -x
          az ml component create --file cli/jobs/pipelines-with-components/basics/1b_e2e_registered_components/train.yml
          az ml component create --file cli/jobs/pipelines-with-components/basics/1b_e2e_registered_components/score.yml
          az ml component create --file cli/jobs/pipelines-with-components/basics/1b_e2e_registered_components/eval.yml

      - name: run job
        run: |
          bash .github/amlarc-tool.sh run_cli_job cli/jobs/pipelines-with-components/basics/1b_e2e_registered_components/pipeline.yml \
            -cr