name: amlarc-examples-test
on:
  workflow_dispatch:
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: check out repo
      uses: actions/checkout@v2
    - name: setup python
      uses: actions/setup-python@v2
      with:
        python-version: "3.8"
    - name: install az cli
      shell: bash
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | bash
    - name: install tools
      run: bash .github/amlarc-tool.sh install_tools
      timeout-minutes: 30
    - name: azure login
      uses: azure/login@v1
      with:
        creds: ${{secrets.AZ_AE_CREDS}}
      timeout-minutes: 30
    - name: get kubeconfig
      shell: bash
      run: |
        bash .github/amlarc-tool.sh get_kubeconfig
    - name: set compute target
      shell: bash
      run: |
        bash .github/amlarc-tool.sh setup_instance_type defaultinstancetype 2 4Gi
        bash .github/amlarc-tool.sh setup_instance_type cpu 2 4Gi
        bash .github/amlarc-tool.sh setup_instance_type gpu 2 4Gi 1
        bash -c "echo Waiting 30 seconds for instance type to take effect ...; sleep 30"
    # setup repo
    - name: create dataset
      run: |
        az account set --subscription $SUBSCRIPTION
        az configure --defaults group=$RESOURCE_GROUP workspace=$WORKSPACE location=$LOCATION
        bash create-datasets.sh
      working-directory: setup-repo
      timeout-minutes: 30