$schema: https://azuremlschemas.azureedge.net/latest/pipelineJob.schema.json
type: pipeline

experiment_name: AzureML-Train-Finetune-Vision-MultiLabel-Samples

inputs:
  # # model - specify the foundation model available in the azureml system registry
  mlflow_model_path:
    path: azureml://registries/azureml-preview/models/google-vit-base-patch16-224/versions/1
    type: mlflow_model
  # model_name: microsoft/beit-base-patch16-224-pt22k-ft22k
  # dataset files
  training_data:
    path: ./data/training-mltable-folder
    type: mltable
  validation_data:
    path: ./data/validation-mltable-folder
    type: mltable
  # deepspeed config file
  ds_finetune:
    path: ./deepspeed_configs/zero1.json
    type: uri_file
  # compute
  compute_model_import: sample-model-import-cluster
  compute_finetune: sample-finetune-cluster-gpu-nc6


outputs:
  # map the output of the fine tuning job to the output of pipeline job so that we can easily register the fine tuned model
  # registering the model is required to deploy the model to an online or batch endpoint
  trained_model:
    type: mlflow_model

settings:
  force_rerun: true
  default_compute: azureml:sample-finetune-cluster-gpu-nc6

jobs:
  huggingface_transformers_model_finetune_job:
    type: pipeline
    component: azureml://registries/azureml-preview/components/image_classification_pipeline/labels/latest
    inputs:

      # Compute
      compute_model_import: ${{parent.inputs.compute_model_import}}
      compute_finetune: ${{parent.inputs.compute_finetune}}
      process_count_per_instance: 1
      instance_count: 1

      # model
      task_name: image-classification-multilabel
      model_family: HuggingFaceImage
      # # specify the model_name instead of mlflow_model if you want to use a model from the huggingface hub
      mlflow_model: ${{parent.inputs.mlflow_model_path}} 
      # model_name: ${{parent.inputs.model_name}}

      # data
      training_data: ${{parent.inputs.training_data}}
      validation_data: ${{parent.inputs.validation_data}}

      auto_hyperparameter_selection: False
      image_width: -1
      image_height: -1
      metric_for_best_model: iou
      apply_augmentations: True
      number_of_workers: 8
      apply_deepspeed: False
      deepspeed_config: ${{parent.inputs.ds_finetune}}
      apply_ort: False
      number_of_epochs: 15
      max_steps: -1
      training_batch_size: 4
      validation_batch_size: 4
      auto_find_batch_size: False
      learning_rate: 5e-5
      learning_rate_scheduler: warmup_linear
      warmup_steps: 0
      optimizer: adamw_hf
      weight_decay: 0.0
      extra_optim_args: ""
      gradient_accumulation_step: 1
      precision: 32
      label_smoothing_factor: 0.0
      random_seed: 42
      evaluation_strategy: epoch
      evaluation_steps: 500
      logging_strategy: epoch
      logging_steps: 500
      save_strategy: epoch
      save_steps: 500
      save_total_limit: -1
      early_stopping: False
      early_stopping_patience: 1
      max_grad_norm: 1.0
      resume_from_checkpoint: False
      save_as_mlflow_model: True

    outputs:
      mlflow_model_folder: ${{parent.outputs.trained_model}}