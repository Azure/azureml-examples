# This runs NCCL test "all_reduce_perf" on a gpu node.
# It helps diagnosis of health of perf issues.
#
# NOTES:
# - set the name of the compute
# - set process_count_per_instance to the number of gpu on the node
# - for multi-node, set instance_count

type: command

command: |
  nvcc --version &&
  nvidia-smi &&
  all_reduce_perf -e ${{inputs.maxbytes}} -f ${{inputs.stepfactor}} -g ${{inputs.ngpus}}

inputs:
  # arguments for nccl_test
  ngpus: 1 # leave at 1
  maxbytes: "8G"
  stepfactor: 2

environment: azureml:nccl_test_openmpi4-1-0-cuda11-1-cudnn8-ubuntu18-04:4

environment_variables: # NOTE: set env var if needed by your configuration
  NCCL_DEBUG: "INFO"
  NCCL_IB_PCI_RELAXED_ORDERING: "1"
  UCX_TLS: "tcp"
  UCX_NET_DEVICES: "eth0"
  CUDA_DEVICE_ORDER: "PCI_BUS_ID"
  NCCL_SOCKET_IFNAME: "eth0"
  NCCL_TOPO_FILE: "/opt/microsoft/ndv4-topo.xml"

# NOTE: name of the compute cluster
compute: azureml:gpu-cluster

distribution:
  type: mpi
  # NOTE: set equal to number of gpus
  process_count_per_instance: 4

resources:
  instance_count: 1 # NOTE: to use multiple nodes

experiment_name: nccl-test
display_name: Gpu Diag (NCCL tests)
description: Runs NCCL-tests on gpu nodes.
